{% extends "base.html" %}

{% block title %}Query Statistics{% endblock %}

{% block content %}
<div class="container">
    <h1>Query Statistics & Analytics</h1>
    
    <div class="stats-grid">
        <!-- Query Types Chart -->
        <div class="chart-container">
            <h3>Query Type Distribution</h3>
            <canvas id="queryTypesChart"></canvas>
        </div>
        
        <!-- Table Usage Chart -->
        <div class="chart-container">
            <h3>Table Usage Frequency</h3>
            <canvas id="tableUsageChart"></canvas>
        </div>
        
        <!-- Hourly Distribution Chart -->
        <div class="chart-container">
            <h3>Query Distribution by Hour</h3>
            <canvas id="hourlyChart"></canvas>
        </div>
        
        <!-- Query Complexity Chart -->
        <div class="chart-container">
            <h3>Query Complexity Analysis</h3>
            <canvas id="complexityChart"></canvas>
        </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="stats-summary">
        <h3>Summary Statistics</h3>
        <div class="summary-grid">
            <div class="stat-card">
                <h4>Total Queries</h4>
                <span id="totalQueries" class="stat-number">0</span>
            </div>
            <div class="stat-card">
                <h4>Most Used Query Type</h4>
                <span id="mostUsedType" class="stat-text">-</span>
            </div>
            <div class="stat-card">
                <h4>Most Accessed Table</h4>
                <span id="mostUsedTable" class="stat-text">-</span>
            </div>
            <div class="stat-card">
                <h4>Peak Hour</h4>
                <span id="peakHour" class="stat-text">-</span>
            </div>
        </div>
    </div>
    
    <!-- Refresh Button -->
    <div class="refresh-controls">
        <button id="refreshStats" class="btn btn-primary">Refresh Statistics</button>
        <span class="last-updated">Last updated: <span id="lastUpdated">-</span></span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

// Colors for charts
const colors = {
    primary: '#3498db',
    secondary: '#e74c3c',
    success: '#2ecc71',
    warning: '#f39c12',
    info: '#9b59b6',
    light: '#ecf0f1',
    dark: '#34495e'
};

// Initialize charts
function initCharts() {
    // Query Types Chart (Doughnut)
    const queryTypesCtx = document.getElementById('queryTypesChart').getContext('2d');
    charts.queryTypes = new Chart(queryTypesCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    colors.primary,
                    colors.secondary,
                    colors.success,
                    colors.warning,
                    colors.info
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Table Usage Chart (Bar)
    const tableUsageCtx = document.getElementById('tableUsageChart').getContext('2d');
    charts.tableUsage = new Chart(tableUsageCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Query Count',
                data: [],
                backgroundColor: colors.primary,
                borderColor: colors.dark,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Hourly Distribution Chart (Line)
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    charts.hourly = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Queries per Hour',
                data: [],
                borderColor: colors.success,
                backgroundColor: colors.success + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                },
                x: {
                    title: {
                        display: true,
                        text: 'Hour of Day'
                    }
                }
            }
        }
    });
    
    // Query Complexity Chart (Polar Area)
    const complexityCtx = document.getElementById('complexityChart').getContext('2d');
    charts.complexity = new Chart(complexityCtx, {
        type: 'polarArea',
        data: {
            labels: ['Simple', 'Medium', 'Complex'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    colors.success,
                    colors.warning,
                    colors.secondary
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Load statistics data
async function loadStatistics() {
    try {
        const response = await fetch('/api/statistics');
        const data = await response.json();
        
        updateCharts(data);
        updateSummary(data);
        updateLastUpdated();
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Update all charts with new data
function updateCharts(data) {
    // Update Query Types Chart
    const queryTypes = data.query_types || {};
    charts.queryTypes.data.labels = Object.keys(queryTypes);
    charts.queryTypes.data.datasets[0].data = Object.values(queryTypes);
    charts.queryTypes.update();
    
    // Update Table Usage Chart
    const tableUsage = data.table_usage || {};
    charts.tableUsage.data.labels = Object.keys(tableUsage);
    charts.tableUsage.data.datasets[0].data = Object.values(tableUsage);
    charts.tableUsage.update();
    
    // Update Hourly Distribution Chart
    const hourlyData = data.hourly_distribution || {};
    const hours = Array.from({length: 24}, (_, i) => i);
    const hourlyCounts = hours.map(hour => hourlyData[hour] || 0);
    
    charts.hourly.data.labels = hours.map(h => h + ':00');
    charts.hourly.data.datasets[0].data = hourlyCounts;
    charts.hourly.update();
    
    // Update Query Complexity Chart
    const complexity = data.query_complexity || {};
    charts.complexity.data.datasets[0].data = [
        complexity.simple || 0,
        complexity.medium || 0,
        complexity.complex || 0
    ];
    charts.complexity.update();
}

// Update summary statistics
function updateSummary(data) {
    document.getElementById('totalQueries').textContent = data.total_queries || 0;
    
    // Most used query type
    const queryTypes = data.query_types || {};
    const mostUsedType = Object.keys(queryTypes).reduce((a, b) => 
        queryTypes[a] > queryTypes[b] ? a : b, '-');
    document.getElementById('mostUsedType').textContent = mostUsedType;
    
    // Most used table
    const tableUsage = data.table_usage || {};
    const mostUsedTable = Object.keys(tableUsage).reduce((a, b) => 
        tableUsage[a] > tableUsage[b] ? a : b, '-');
    document.getElementById('mostUsedTable').textContent = mostUsedTable;
    
    // Peak hour
    const hourlyData = data.hourly_distribution || {};
    const peakHour = Object.keys(hourlyData).reduce((a, b) => 
        hourlyData[a] > hourlyData[b] ? a : b, '-');
    document.getElementById('peakHour').textContent = peakHour !== '-' ? peakHour + ':00' : '-';
}

// Update last updated timestamp
function updateLastUpdated() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
}

// Event listeners
document.getElementById('refreshStats').addEventListener('click', loadStatistics);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadStatistics();
    
    // Auto-refresh every 30 seconds
    setInterval(loadStatistics, 30000);
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    height: 400px;
}

.chart-container h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 1.2em;
}

.chart-container canvas {
    max-height: 300px;
}

.stats-summary {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.stat-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    text-align: center;
}

.stat-card h4 {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #3498db;
}

.stat-text {
    font-size: 1.2em;
    font-weight: 500;
    color: #333;
}

.refresh-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.last-updated {
    color: #666;
    font-size: 0.9em;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
}
</style>
{% endblock %}






