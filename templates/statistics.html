{% extends "base.html" %}

{% block title %}Query Statistics{% endblock %}

{% block content %}
<div class="container">
    <h1>Query Statistics & Analytics</h1>
    
    <div class="stats-grid">
        <!-- Query Types Chart -->
        <div class="chart-container">
            <h3>Query Type Distribution</h3>
            <canvas id="queryTypesChart"></canvas>
        </div>
        
        <!-- Table Usage Chart -->
        <div class="chart-container">
            <h3>Table Usage Frequency</h3>
            <canvas id="tableUsageChart"></canvas>
        </div>
        
        <!-- Column Frequency Bar Chart -->
        <div class="chart-container">
            <h3>Column Frequency (Count)</h3>
            <canvas id="columnFreqBarChart"></canvas>
        </div>
        
        <!-- Column Frequency Pie Chart -->
        <div class="chart-container">
            <h3>Column Frequency (Percentage)</h3>
            <canvas id="columnFreqPieChart"></canvas>
        </div>
    </div>
    
    <!-- Current Indexes -->
    <div class="stats-summary">
        <h3>Current Indexes</h3>
        <div id="indexesList" class="indexes-list"></div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="stats-summary">
        <h3>Summary Statistics</h3>
        <div class="summary-grid">
            <div class="stat-card">
                <h4>Total Queries</h4>
                <span id="totalQueries" class="stat-number">0</span>
            </div>
            <div class="stat-card">
                <h4>Most Used Query Type</h4>
                <span id="mostUsedType" class="stat-text">-</span>
            </div>
            <div class="stat-card">
                <h4>Most Accessed Table</h4>
                <span id="mostUsedTable" class="stat-text">-</span>
            </div>
        </div>
    </div>
    
    <!-- Auto-refresh indicator -->
    <div class="refresh-controls">
        <span class="last-updated">Last updated: <span id="lastUpdated">-</span></span>
        <span class="auto-refresh-indicator">ðŸ”„ Auto-refreshing...</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

// Colors for charts
const colors = {
    primary: '#3498db',
    secondary: '#e74c3c',
    success: '#2ecc71',
    warning: '#f39c12',
    info: '#9b59b6',
    light: '#ecf0f1',
    dark: '#34495e'
};

// Initialize charts
function initCharts() {
    // Query Types Chart (Doughnut)
    const queryTypesCtx = document.getElementById('queryTypesChart').getContext('2d');
    charts.queryTypes = new Chart(queryTypesCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    colors.primary,
                    colors.secondary,
                    colors.success,
                    colors.warning,
                    colors.info
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Table Usage Chart (Bar)
    const tableUsageCtx = document.getElementById('tableUsageChart').getContext('2d');
    charts.tableUsage = new Chart(tableUsageCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Query Count',
                data: [],
                backgroundColor: colors.primary,
                borderColor: colors.dark,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Column Frequency Bar Chart
    const columnFreqBarCtx = document.getElementById('columnFreqBarChart').getContext('2d');
    charts.columnFreqBar = new Chart(columnFreqBarCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Frequency',
                data: [],
                backgroundColor: colors.success,
                borderColor: colors.dark,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Column Frequency Pie Chart
    const columnFreqPieCtx = document.getElementById('columnFreqPieChart').getContext('2d');
    charts.columnFreqPie = new Chart(columnFreqPieCtx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    colors.primary,
                    colors.secondary,
                    colors.success,
                    colors.warning,
                    colors.info,
                    '#e67e22',
                    '#1abc9c',
                    '#95a5a6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
}

// Load statistics data
async function loadStatistics() {
    try {
        const response = await fetch('/api/statistics');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Statistics data received:', data);
        
        updateCharts(data);
        updateSummary(data);
        updateLastUpdated();
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        // Show error message to user
        const errorMsg = document.createElement('div');
        errorMsg.className = 'error-message';
        errorMsg.textContent = 'Error loading statistics. Please check console for details.';
        errorMsg.style.cssText = 'background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0;';
        const container = document.querySelector('.container');
        if (container && !document.querySelector('.error-message')) {
            container.insertBefore(errorMsg, container.firstChild);
        }
    }
}

// Update all charts with new data
function updateCharts(data) {
    // Update Query Types Chart
    const queryTypes = data.query_types || {};
    if (Object.keys(queryTypes).length > 0) {
        charts.queryTypes.data.labels = Object.keys(queryTypes);
        charts.queryTypes.data.datasets[0].data = Object.values(queryTypes);
        charts.queryTypes.update();
    } else {
        charts.queryTypes.data.labels = ['No Data'];
        charts.queryTypes.data.datasets[0].data = [1];
        charts.queryTypes.update();
    }
    
    // Update Table Usage Chart
    const tableUsage = data.table_usage || {};
    if (Object.keys(tableUsage).length > 0) {
        charts.tableUsage.data.labels = Object.keys(tableUsage);
        charts.tableUsage.data.datasets[0].data = Object.values(tableUsage);
        charts.tableUsage.update();
    } else {
        charts.tableUsage.data.labels = ['No Data'];
        charts.tableUsage.data.datasets[0].data = [0];
        charts.tableUsage.update();
    }
    
    // Update Column Frequency Charts
    const columnFreq = data.column_frequency || [];
    if (columnFreq.length > 0) {
        // Bar chart - show top 10
        const topColumns = columnFreq.slice(0, 10);
        charts.columnFreqBar.data.labels = topColumns.map(c => `${c.table}.${c.column}`);
        charts.columnFreqBar.data.datasets[0].data = topColumns.map(c => c.frequency);
        charts.columnFreqBar.update();
        
        // Pie chart - show top 8
        const topForPie = columnFreq.slice(0, 8);
        charts.columnFreqPie.data.labels = topForPie.map(c => `${c.table}.${c.column}`);
        charts.columnFreqPie.data.datasets[0].data = topForPie.map(c => c.percent);
        charts.columnFreqPie.update();
    } else {
        // Show placeholder when no data
        charts.columnFreqBar.data.labels = ['No Data Yet'];
        charts.columnFreqBar.data.datasets[0].data = [0];
        charts.columnFreqBar.update();
        
        charts.columnFreqPie.data.labels = ['No Data Yet'];
        charts.columnFreqPie.data.datasets[0].data = [100];
        charts.columnFreqPie.update();
    }
    
    // Update Current Indexes
    const indexes = data.current_indexes || [];
    const indexesList = document.getElementById('indexesList');
    if (indexes.length > 0) {
        indexesList.innerHTML = indexes.map(idx => `
            <div class="index-item">
                <strong>${idx.name}</strong> on <code>${idx.table}</code>
            </div>
        `).join('');
    } else {
        indexesList.innerHTML = '<p>No indexes currently active.</p>';
    }
}

// Update summary statistics
function updateSummary(data) {
    document.getElementById('totalQueries').textContent = data.total_queries || 0;
    
    // Most used query type
    const queryTypes = data.query_types || {};
    const mostUsedType = Object.keys(queryTypes).reduce((a, b) => 
        queryTypes[a] > queryTypes[b] ? a : b, '-');
    document.getElementById('mostUsedType').textContent = mostUsedType;
    
    // Most used table
    const tableUsage = data.table_usage || {};
    const mostUsedTable = Object.keys(tableUsage).reduce((a, b) => 
        tableUsage[a] > tableUsage[b] ? a : b, '-');
    document.getElementById('mostUsedTable').textContent = mostUsedTable;
}

// Update last updated timestamp
function updateLastUpdated() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadStatistics();
    
    // Auto-refresh every 2 seconds for real-time updates
    setInterval(loadStatistics, 2000);
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    height: 400px;
}

.chart-container h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 1.2em;
}

.chart-container canvas {
    max-height: 300px;
}

.stats-summary {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.stat-card {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    text-align: center;
}

.stat-card h4 {
    margin: 0 0 10px 0;
    color: #666;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #3498db;
}

.stat-text {
    font-size: 1.2em;
    font-weight: 500;
    color: #333;
}

.refresh-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.last-updated {
    color: #666;
    font-size: 0.9em;
}

.auto-refresh-indicator {
    color: #2ecc71;
    font-size: 0.85em;
    font-weight: 500;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.6;
    }
}

.indexes-list {
    margin-top: 15px;
}

.index-item {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 10px;
    border-left: 3px solid #3498db;
}

.index-item strong {
    color: #333;
}

.index-item code {
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
}
</style>
{% endblock %}








